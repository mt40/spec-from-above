<!doctype html>
<html lang="en" data-theme="wireframe">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>SpecStack</title>
		<meta name="description" content="A free library of software specifications">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="SpecStack">
		<meta name="generator" content="Eleventy v3.0.0">

		
		<link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css">
		<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
		<link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css">

		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
		<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">
		

		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
	min-height: 100vh; /* Ensure minimum height is full viewport */
}
html {
	overflow-y: scroll;
}
body {
	max-width: 60em;
	display: flex;          /* Add flex display */
	flex-direction: column; /* Stack children vertically */
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

/* Make main content grow to push footer down */
main {
	flex: 1;               /* Allow main to grow and fill space */
	width: 100%;          /* Ensure full width */
}

main,
footer {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}
@import "tailwindcss";

/* Read: https://daisyui.com/docs/themes/ */

@plugin "daisyui" {
  themes: light --default, dark --prefersdark, wireframe;
}
/* Base font settings for all code elements */
		pre code,
		pre code *,
		pre code span *,
		.hljs,
		.hljs *,
		.hljs span *,
		.code-sample,
		.code-sample *,
		.code-sample span * {
			font-family: "Fira Code", monospace !important;
			font-variant-ligatures: common-ligatures !important;
			font-feature-settings: 
				"liga" 1,    /* Standard ligatures */
				"calt" 1,    /* Contextual alternates */
				"dlig" 1,    /* Discretionary ligatures */
				"ss01" 1,    /* Style set 1 - includes \/ for ∨ */
				"ss02" 1,    /* Style set 2 - includes <> for ≠ */
				"ss03" 1,    /* Style set 3 - includes more operators */
				"ss04" 1,    /* Style set 4 - includes more operators */
				"ss05" 1,    /* Style set 5 - includes more operators */
				"ss06" 1,    /* Style set 6 - includes more operators */
				"ss07" 1 !important;    /* Style set 7 - includes more operators */
		}

		/* Override any highlight.js font settings */
		.hljs {
			font-family: "Fira Code", monospace !important;
		}</style>

		

		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/solarized-light.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>
		<div class="navbar bg-accent shadow-sm">
			<div class="flex-1">
				<a href="/" class="home-link btn btn-ghost text-xl">SpecStack</a>
			</div>
			<div class="flex-none">
				<ul class="menu menu-horizontal px-1">
						<li class="nav-item"><a href="/">Home</a></li>
						<li class="nav-item"><a href="/blog/">Archive</a></li>
						<li class="nav-item"><a href="/about/">About</a></li>
						<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
					<li class="nav-item"><a href="https://github.com/prestonph/specstack">Contribute</a></li>
				</ul>
			</div>
		</div>

		<main id="skip">
			<heading-anchors>
				
<div>
	<time datetime="2025-04-06">06 April 2025</time>
</div>

<h1 class="text-2xl mb-8 font-bold"></h1>

<div class="mb-8">
	<ul class="post-metadata">
		<li>
			<div class="badge">
				<a href="/tags/language-pluscal/" class="post-tag text-neutral">language -- PlusCal</a>
			</div>
		</li>
	</ul>
</div>

<p class="mb-8"></p>

<div class="mb-8">
	<pre><code>---- MODULE scci_p1 ----
EXTENDS TLC, Naturals, Integers, Sequences, FiniteSets

\* model values
\* ---------------
CONSTANTS NULL

\* constants
\* ---------------
MESSAGE_TYPE == {"m1", "m2", "m3"}
MESSAGES_TO_SEND_COUNT == 3

\* types
\* ---------------
LogType == [diff: BOOLEAN, ctime: Nat, msg: MESSAGE_TYPE]
DataType == [mtime: Nat]

\* utilities
SeqOf(set, count) == [1..count -> set]

(*--algorithm scci_p1
    variables
        \* Pick from possible messages.
        \* Simulate duplicate messages.
        all_messages \in SeqOf(MESSAGE_TYPE, MESSAGES_TO_SEND_COUNT),
        \* our database
        data = [mtime |-> 0],
        \* Use set to simulate out-of-order messages (e.g. retry)
        \* For simplicity, we assume that kafka is partitioned by key already
        msg_queue = {},
        msg_to_send = all_messages,

        \* ghost variables
        \* ---------------
        produced_msg = {},
        consumed_msg = <<>>,
        \* set of LogType
        compare_and_update_log = {};

    define
        \* safety
        \* ---------------
        \* Older data can never overwrite newer data
        Integrity == \A log \in compare_and_update_log : ~log.diff \/ (log.ctime <= data.mtime)

        \* liveness
        \* ---------------
        \* Assuming API call & producing msg are atomic, when API is called, eventually C&U will run
        Progress == <>(\A msg \in produced_msg : (\E log \in compare_and_update_log : log.msg = msg))
        \* If Compare shows diff, data is eventually updated to newer
        Validity == <>(\A log \in compare_and_update_log : log.diff => (log.ctime <= data.mtime))

    end define;

    procedure fail_by_budget(budget=0)
        variables
            internal_budget = budget;
        begin
        MayFail:
            either
                if internal_budget > 0 then
                    internal_budget := internal_budget - 1;
                    goto MayFail;
                else
                    return;
                end if;
            or
                return;
            end either;
    end procedure;

    fair process producer = "producer"
    variables
        failure_budget = 3;
    begin
        ActionProducerPreCheck:
            if Len(msg_to_send) = 0 then
                goto ActionProducerDone;
            end if;
        
        ActionProducerMayFail:
            call fail_by_budget(failure_budget);

        ActionProducerLoop:
            msg_queue := msg_queue \union {Head(msg_to_send)};
            produced_msg := produced_msg \union {Head(msg_to_send)};
            msg_to_send := Tail(msg_to_send);
        
        ActionProducerNextStep:
            goto ActionProducerPreCheck;
        
        ActionProducerDone:
            skip;
    end process;

    fair process consumer = "consumer"
    variable
        clock = 1,
        cur_msg = "no message",
        log = [diff |-> FALSE, ctime |-> 0, msg |-> "no message"]; \* LogType
    begin
        ActionConsumerWait:
            await Cardinality(msg_queue) > 0;
        
        ActionConsumeMsgMayFail:
            call fail_by_budget(failure_budget);

        ActionConsumeMsg:
            cur_msg := CHOOSE m \in msg_queue: TRUE;
            log := [diff |-> FALSE, ctime |-> clock, msg |-> cur_msg];
            clock := clock + 1;
        
        ActionCompareMayFail:
            call fail_by_budget(failure_budget);

        ActionCompare:
            either
                log.diff := FALSE;
            or
                log.diff := TRUE;
            end either;
            clock := clock + 1;
        
        ActionUpdateMayFail:
            call fail_by_budget(failure_budget);
        
        ActionUpdate:
            if log.diff then
                data.mtime := clock;
            end if;
            clock := clock + 1;
        
        ActionMsgACKMayFail:
            call fail_by_budget(failure_budget);
        
        ActionMsgACK:
            consumed_msg := Append(consumed_msg, cur_msg);
            msg_queue := msg_queue \ {cur_msg};
            clock := clock + 1;
            compare_and_update_log := compare_and_update_log \union {log};
        
        ActionConsumerNextStep:
            goto ActionConsumerWait;
    end process; 

    end algorithm; *)
\* BEGIN TRANSLATION (chksum(pcal) = "5ffe163b" /\ chksum(tla) = "789a10f4")
VARIABLES all_messages, data, msg_queue, msg_to_send, produced_msg, 
          consumed_msg, compare_and_update_log, pc, stack

(* define statement *)
Integrity == \A log \in compare_and_update_log : ~log.diff \/ (log.ctime <= data.mtime)




Progress == <>(\A msg \in produced_msg : (\E log \in compare_and_update_log : log.msg = msg))

Validity == <>(\A log \in compare_and_update_log : log.diff => (log.ctime <= data.mtime))

VARIABLES budget, internal_budget, failure_budget, clock, cur_msg, log

vars == << all_messages, data, msg_queue, msg_to_send, produced_msg, 
           consumed_msg, compare_and_update_log, pc, stack, budget, 
           internal_budget, failure_budget, clock, cur_msg, log >>

ProcSet == {"producer"} \cup {"consumer"}

Init == (* Global variables *)
        /\ all_messages \in SeqOf(MESSAGE_TYPE, MESSAGES_TO_SEND_COUNT)
        /\ data = [mtime |-> 0]
        /\ msg_queue = {}
        /\ msg_to_send = all_messages
        /\ produced_msg = {}
        /\ consumed_msg = <<>>
        /\ compare_and_update_log = {}
        (* Procedure fail_by_budget *)
        /\ budget = [ self \in ProcSet |-> 0]
        /\ internal_budget = [ self \in ProcSet |-> budget[self]]
        (* Process producer *)
        /\ failure_budget = 3
        (* Process consumer *)
        /\ clock = 1
        /\ cur_msg = "no message"
        /\ log = [diff |-> FALSE, ctime |-> 0, msg |-> "no message"]
        /\ stack = [self \in ProcSet |-> << >>]
        /\ pc = [self \in ProcSet |-> CASE self = "producer" -> "ActionProducerPreCheck"
                                        [] self = "consumer" -> "ActionConsumerWait"]

MayFail(self) == /\ pc[self] = "MayFail"
                 /\ \/ /\ IF internal_budget[self] > 0
                             THEN /\ internal_budget' = [internal_budget EXCEPT ![self] = internal_budget[self] - 1]
                                  /\ pc' = [pc EXCEPT ![self] = "MayFail"]
                                  /\ UNCHANGED << stack, budget >>
                             ELSE /\ pc' = [pc EXCEPT ![self] = Head(stack[self]).pc]
                                  /\ internal_budget' = [internal_budget EXCEPT ![self] = Head(stack[self]).internal_budget]
                                  /\ budget' = [budget EXCEPT ![self] = Head(stack[self]).budget]
                                  /\ stack' = [stack EXCEPT ![self] = Tail(stack[self])]
                    \/ /\ pc' = [pc EXCEPT ![self] = Head(stack[self]).pc]
                       /\ internal_budget' = [internal_budget EXCEPT ![self] = Head(stack[self]).internal_budget]
                       /\ budget' = [budget EXCEPT ![self] = Head(stack[self]).budget]
                       /\ stack' = [stack EXCEPT ![self] = Tail(stack[self])]
                 /\ UNCHANGED << all_messages, data, msg_queue, msg_to_send, 
                                 produced_msg, consumed_msg, 
                                 compare_and_update_log, failure_budget, clock, 
                                 cur_msg, log >>

fail_by_budget(self) == MayFail(self)

ActionProducerPreCheck == /\ pc["producer"] = "ActionProducerPreCheck"
                          /\ IF Len(msg_to_send) = 0
                                THEN /\ pc' = [pc EXCEPT !["producer"] = "ActionProducerDone"]
                                ELSE /\ pc' = [pc EXCEPT !["producer"] = "ActionProducerMayFail"]
                          /\ UNCHANGED << all_messages, data, msg_queue, 
                                          msg_to_send, produced_msg, 
                                          consumed_msg, compare_and_update_log, 
                                          stack, budget, internal_budget, 
                                          failure_budget, clock, cur_msg, log >>

ActionProducerMayFail == /\ pc["producer"] = "ActionProducerMayFail"
                         /\ /\ budget' = [budget EXCEPT !["producer"] = failure_budget]
                            /\ stack' = [stack EXCEPT !["producer"] = << [ procedure |->  "fail_by_budget",
                                                                           pc        |->  "ActionProducerLoop",
                                                                           internal_budget |->  internal_budget["producer"],
                                                                           budget    |->  budget["producer"] ] >>
                                                                       \o stack["producer"]]
                         /\ internal_budget' = [internal_budget EXCEPT !["producer"] = budget'["producer"]]
                         /\ pc' = [pc EXCEPT !["producer"] = "MayFail"]
                         /\ UNCHANGED << all_messages, data, msg_queue, 
                                         msg_to_send, produced_msg, 
                                         consumed_msg, compare_and_update_log, 
                                         failure_budget, clock, cur_msg, log >>

ActionProducerLoop == /\ pc["producer"] = "ActionProducerLoop"
                      /\ msg_queue' = (msg_queue \union {Head(msg_to_send)})
                      /\ produced_msg' = (produced_msg \union {Head(msg_to_send)})
                      /\ msg_to_send' = Tail(msg_to_send)
                      /\ pc' = [pc EXCEPT !["producer"] = "ActionProducerNextStep"]
                      /\ UNCHANGED << all_messages, data, consumed_msg, 
                                      compare_and_update_log, stack, budget, 
                                      internal_budget, failure_budget, clock, 
                                      cur_msg, log >>

ActionProducerNextStep == /\ pc["producer"] = "ActionProducerNextStep"
                          /\ pc' = [pc EXCEPT !["producer"] = "ActionProducerPreCheck"]
                          /\ UNCHANGED << all_messages, data, msg_queue, 
                                          msg_to_send, produced_msg, 
                                          consumed_msg, compare_and_update_log, 
                                          stack, budget, internal_budget, 
                                          failure_budget, clock, cur_msg, log >>

ActionProducerDone == /\ pc["producer"] = "ActionProducerDone"
                      /\ TRUE
                      /\ pc' = [pc EXCEPT !["producer"] = "Done"]
                      /\ UNCHANGED << all_messages, data, msg_queue, 
                                      msg_to_send, produced_msg, consumed_msg, 
                                      compare_and_update_log, stack, budget, 
                                      internal_budget, failure_budget, clock, 
                                      cur_msg, log >>

producer == ActionProducerPreCheck \/ ActionProducerMayFail
               \/ ActionProducerLoop \/ ActionProducerNextStep
               \/ ActionProducerDone

ActionConsumerWait == /\ pc["consumer"] = "ActionConsumerWait"
                      /\ Cardinality(msg_queue) > 0
                      /\ pc' = [pc EXCEPT !["consumer"] = "ActionConsumeMsgMayFail"]
                      /\ UNCHANGED << all_messages, data, msg_queue, 
                                      msg_to_send, produced_msg, consumed_msg, 
                                      compare_and_update_log, stack, budget, 
                                      internal_budget, failure_budget, clock, 
                                      cur_msg, log >>

ActionConsumeMsgMayFail == /\ pc["consumer"] = "ActionConsumeMsgMayFail"
                           /\ /\ budget' = [budget EXCEPT !["consumer"] = failure_budget]
                              /\ stack' = [stack EXCEPT !["consumer"] = << [ procedure |->  "fail_by_budget",
                                                                             pc        |->  "ActionConsumeMsg",
                                                                             internal_budget |->  internal_budget["consumer"],
                                                                             budget    |->  budget["consumer"] ] >>
                                                                         \o stack["consumer"]]
                           /\ internal_budget' = [internal_budget EXCEPT !["consumer"] = budget'["consumer"]]
                           /\ pc' = [pc EXCEPT !["consumer"] = "MayFail"]
                           /\ UNCHANGED << all_messages, data, msg_queue, 
                                           msg_to_send, produced_msg, 
                                           consumed_msg, 
                                           compare_and_update_log, 
                                           failure_budget, clock, cur_msg, log >>

ActionConsumeMsg == /\ pc["consumer"] = "ActionConsumeMsg"
                    /\ cur_msg' = (CHOOSE m \in msg_queue: TRUE)
                    /\ log' = [diff |-> FALSE, ctime |-> clock, msg |-> cur_msg']
                    /\ clock' = clock + 1
                    /\ pc' = [pc EXCEPT !["consumer"] = "ActionCompareMayFail"]
                    /\ UNCHANGED << all_messages, data, msg_queue, msg_to_send, 
                                    produced_msg, consumed_msg, 
                                    compare_and_update_log, stack, budget, 
                                    internal_budget, failure_budget >>

ActionCompareMayFail == /\ pc["consumer"] = "ActionCompareMayFail"
                        /\ /\ budget' = [budget EXCEPT !["consumer"] = failure_budget]
                           /\ stack' = [stack EXCEPT !["consumer"] = << [ procedure |->  "fail_by_budget",
                                                                          pc        |->  "ActionCompare",
                                                                          internal_budget |->  internal_budget["consumer"],
                                                                          budget    |->  budget["consumer"] ] >>
                                                                      \o stack["consumer"]]
                        /\ internal_budget' = [internal_budget EXCEPT !["consumer"] = budget'["consumer"]]
                        /\ pc' = [pc EXCEPT !["consumer"] = "MayFail"]
                        /\ UNCHANGED << all_messages, data, msg_queue, 
                                        msg_to_send, produced_msg, 
                                        consumed_msg, compare_and_update_log, 
                                        failure_budget, clock, cur_msg, log >>

ActionCompare == /\ pc["consumer"] = "ActionCompare"
                 /\ \/ /\ log' = [log EXCEPT !.diff = FALSE]
                    \/ /\ log' = [log EXCEPT !.diff = TRUE]
                 /\ clock' = clock + 1
                 /\ pc' = [pc EXCEPT !["consumer"] = "ActionUpdateMayFail"]
                 /\ UNCHANGED << all_messages, data, msg_queue, msg_to_send, 
                                 produced_msg, consumed_msg, 
                                 compare_and_update_log, stack, budget, 
                                 internal_budget, failure_budget, cur_msg >>

ActionUpdateMayFail == /\ pc["consumer"] = "ActionUpdateMayFail"
                       /\ /\ budget' = [budget EXCEPT !["consumer"] = failure_budget]
                          /\ stack' = [stack EXCEPT !["consumer"] = << [ procedure |->  "fail_by_budget",
                                                                         pc        |->  "ActionUpdate",
                                                                         internal_budget |->  internal_budget["consumer"],
                                                                         budget    |->  budget["consumer"] ] >>
                                                                     \o stack["consumer"]]
                       /\ internal_budget' = [internal_budget EXCEPT !["consumer"] = budget'["consumer"]]
                       /\ pc' = [pc EXCEPT !["consumer"] = "MayFail"]
                       /\ UNCHANGED << all_messages, data, msg_queue, 
                                       msg_to_send, produced_msg, consumed_msg, 
                                       compare_and_update_log, failure_budget, 
                                       clock, cur_msg, log >>

ActionUpdate == /\ pc["consumer"] = "ActionUpdate"
                /\ IF log.diff
                      THEN /\ data' = [data EXCEPT !.mtime = clock]
                      ELSE /\ TRUE
                           /\ data' = data
                /\ clock' = clock + 1
                /\ pc' = [pc EXCEPT !["consumer"] = "ActionMsgACKMayFail"]
                /\ UNCHANGED << all_messages, msg_queue, msg_to_send, 
                                produced_msg, consumed_msg, 
                                compare_and_update_log, stack, budget, 
                                internal_budget, failure_budget, cur_msg, log >>

ActionMsgACKMayFail == /\ pc["consumer"] = "ActionMsgACKMayFail"
                       /\ /\ budget' = [budget EXCEPT !["consumer"] = failure_budget]
                          /\ stack' = [stack EXCEPT !["consumer"] = << [ procedure |->  "fail_by_budget",
                                                                         pc        |->  "ActionMsgACK",
                                                                         internal_budget |->  internal_budget["consumer"],
                                                                         budget    |->  budget["consumer"] ] >>
                                                                     \o stack["consumer"]]
                       /\ internal_budget' = [internal_budget EXCEPT !["consumer"] = budget'["consumer"]]
                       /\ pc' = [pc EXCEPT !["consumer"] = "MayFail"]
                       /\ UNCHANGED << all_messages, data, msg_queue, 
                                       msg_to_send, produced_msg, consumed_msg, 
                                       compare_and_update_log, failure_budget, 
                                       clock, cur_msg, log >>

ActionMsgACK == /\ pc["consumer"] = "ActionMsgACK"
                /\ consumed_msg' = Append(consumed_msg, cur_msg)
                /\ msg_queue' = msg_queue \ {cur_msg}
                /\ clock' = clock + 1
                /\ compare_and_update_log' = (compare_and_update_log \union {log})
                /\ pc' = [pc EXCEPT !["consumer"] = "ActionConsumerNextStep"]
                /\ UNCHANGED << all_messages, data, msg_to_send, produced_msg, 
                                stack, budget, internal_budget, failure_budget, 
                                cur_msg, log >>

ActionConsumerNextStep == /\ pc["consumer"] = "ActionConsumerNextStep"
                          /\ pc' = [pc EXCEPT !["consumer"] = "ActionConsumerWait"]
                          /\ UNCHANGED << all_messages, data, msg_queue, 
                                          msg_to_send, produced_msg, 
                                          consumed_msg, compare_and_update_log, 
                                          stack, budget, internal_budget, 
                                          failure_budget, clock, cur_msg, log >>

consumer == ActionConsumerWait \/ ActionConsumeMsgMayFail
               \/ ActionConsumeMsg \/ ActionCompareMayFail \/ ActionCompare
               \/ ActionUpdateMayFail \/ ActionUpdate
               \/ ActionMsgACKMayFail \/ ActionMsgACK
               \/ ActionConsumerNextStep

(* Allow infinite stuttering to prevent deadlock on termination. *)
Terminating == /\ \A self \in ProcSet: pc[self] = "Done"
               /\ UNCHANGED vars

Next == producer \/ consumer
           \/ (\E self \in ProcSet: fail_by_budget(self))
           \/ Terminating

Spec == /\ Init /\ [][Next]_vars
        /\ WF_vars(producer) /\ WF_vars(fail_by_budget("producer"))
        /\ WF_vars(consumer) /\ WF_vars(fail_by_budget("consumer"))

Termination == <>(\A self \in ProcSet: pc[self] = "Done")

\* END TRANSLATION 
====
</code></pre>
</div>



			</heading-anchors>
		</main>

		<footer class="footer sm:footer-horizontal bg-accent text-accent-content p-10">
			<nav>
				<h6 class="footer-title" id="open-source">Open Source</h6>
				<a href="https://github.com/prestonph/specstack" class="link link-hover">GitHub</a>
			</nav>
			<nav>
				<h6 class="footer-title" id="author">Author</h6>
				<a href="mailto:preston.p@fastmail.com" class="link link-hover">preston.p@fastmail.com</a>
				<a href="/blog" class="link link-hover">My Blog</a>
			</nav>
			<nav>
				<a href="https://www.11ty.dev/" class="link link-hover">Made with Eleventy v3.0.0</a>
			</nav>
		</footer>

		<!-- This page `/specs/pluscal/database_update_flow/scci_p1/` was built on 2025-04-06T10:40:32.036Z -->
		<script type="module" src="/dist/vAf_QIlOuw.js"></script>
	</body>
</html>
