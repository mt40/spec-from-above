<!doctype html>
<html lang="en" data-theme="wireframe">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Two Layered Cache</title>
		<meta name="description" content="
Quint specification for a two-layered cache system. The system consists of
two cache layers (L1 and L2) that store integer values. Clients can read and
write values to the cache. The specification verifies key correctness properties like:

- read-after-write
- write-after-write
- agreement

Check with:
	quint verify 	two_layered_cache.qnt 	--invariant=readAfterWrite,writeAfterWrite 	--temporal=agreement 
Or with TLC using the check_with_tlc.sh script from this repo:
	sh check_with_tlc.sh 	--file ~/projects/quint/examples/classic/distributed/TwoLayeredCache/two_layered_cache.qnt 	--invariant readAfterWrite,writeAfterWrite 	--temporal agreement">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="SpecStack">
		<meta name="generator" content="Eleventy v3.0.0">

		
		<link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css">
		<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
		<link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css">

		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
		<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">
		

		
		<style>/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
	min-height: 100vh; /* Ensure minimum height is full viewport */
}
html {
	overflow-y: scroll;
}
body {
	max-width: 60em;
	display: flex;          /* Add flex display */
	flex-direction: column; /* Stack children vertically */
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

/* Make main content grow to push footer down */
main {
	flex: 1;               /* Allow main to grow and fill space */
	width: 100%;          /* Ensure full width */
}

main,
footer {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em;
	flex-wrap: wrap;
	justify-content: space-between;
	align-items: center;
	padding: 1em;
}
.home-link {
	flex-grow: 1;
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	gap: .5em 1em;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}
@import "tailwindcss";

/* Read: https://daisyui.com/docs/themes/ */

@plugin "daisyui" {
  themes: light --default, dark --prefersdark, wireframe;
}
/* Base font settings for all code elements */
		pre code,
		pre code *,
		pre code span *,
		.hljs,
		.hljs *,
		.hljs span *,
		.code-sample,
		.code-sample *,
		.code-sample span * {
			font-family: "Fira Code", monospace !important;
			font-variant-ligatures: common-ligatures !important;
			font-feature-settings: 
				"liga" 1,    /* Standard ligatures */
				"calt" 1,    /* Contextual alternates */
				"dlig" 1,    /* Discretionary ligatures */
				"ss01" 1,    /* Style set 1 - includes \/ for ∨ */
				"ss02" 1,    /* Style set 2 - includes <> for ≠ */
				"ss03" 1,    /* Style set 3 - includes more operators */
				"ss04" 1,    /* Style set 4 - includes more operators */
				"ss05" 1,    /* Style set 5 - includes more operators */
				"ss06" 1,    /* Style set 6 - includes more operators */
				"ss07" 1 !important;    /* Style set 7 - includes more operators */
		}

		/* Override any highlight.js font settings */
		.hljs {
			font-family: "Fira Code", monospace !important;
		}</style>

		

		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/solarized-light.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>
		<div class="navbar bg-accent shadow-sm">
			<div class="flex-1">
				<a href="/" class="home-link btn btn-ghost text-xl">SpecStack</a>
			</div>
			<div class="flex-none">
				<ul class="menu menu-horizontal px-1">
						<li class="nav-item"><a href="/">Home</a></li>
						<li class="nav-item"><a href="/blog/">Archive</a></li>
						<li class="nav-item"><a href="/about/">About</a></li>
						<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
					<li class="nav-item"><a href="https://github.com/prestonph/specstack">Contribute</a></li>
				</ul>
			</div>
		</div>

		<main id="skip">
			<heading-anchors>
				
<div>
	<time datetime="2025-04-06">06 April 2025</time>
</div>

<h1 class="text-2xl mb-8 font-bold" id="two-layered-cache">Two Layered Cache</h1>

<div class="mb-8">
	<ul class="post-metadata">
		<li>
			<div class="badge">
				<a href="/tags/language-quint/" class="post-tag text-neutral">language -- Quint</a>
			</div>
		</li>
		<li>
			<div class="badge">
				<a href="/tags/author-preston-p-fastmail-com/" class="post-tag text-neutral">author -- preston.p@fastmail.com</a>
			</div>
		</li>
		<li>
			<div class="badge">
				<a href="/tags/level-of-detail-low/" class="post-tag text-neutral">level of detail -- low</a>
			</div>
		</li>
	</ul>
</div>

<p class="mb-8">
Quint specification for a two-layered cache system. The system consists of
two cache layers (L1 and L2) that store integer values. Clients can read and
write values to the cache. The specification verifies key correctness properties like:

- read-after-write
- write-after-write
- agreement

Check with:
	quint verify 	two_layered_cache.qnt 	--invariant=readAfterWrite,writeAfterWrite 	--temporal=agreement 
Or with TLC using the check_with_tlc.sh script from this repo:
	sh check_with_tlc.sh 	--file ~/projects/quint/examples/classic/distributed/TwoLayeredCache/two_layered_cache.qnt 	--invariant readAfterWrite,writeAfterWrite 	--temporal agreement</p>

<div class="mb-8">
	<pre><code>// -*- mode: Bluespec; -*-

 /** 
  * Quint specification for a two-layered cache system. The system consists of
  * two cache layers (L1 and L2) that store integer values. Clients can read and
  * write values to the cache. The specification verifies key properties like
  * read-after-write consistency and write-after-write consistency across the
  * cache layers.
  * 
  * Check with:
  *   quint verify \
  *     two_layered_cache.qnt \
  *     --invariant=readAfterWrite,writeAfterWrite \
  *     --temporal=agreement \
  *
  * Or with TLC using the `check_with_tlc.sh` script from this repo:
  *   sh check_with_tlc.sh \
  *     --file ~/projects/quint/examples/classic/distributed/TwoLayeredCache/two_layered_cache.qnt \
  *     --invariant readAfterWrite,writeAfterWrite \
  *     --temporal agreement
  *
  * Preston Pham (@mt40), 2025
  */ 

module two_layered_cache {
    //**********************************************************
    // TYPE DEFINITIONS
    //**********************************************************

    type CacheLayer = str -> int
    type ClientPID = int

    type HistoryEntry = Read(int) | Write(int)

    //**********************************************************
    // CONSTANTS
    //**********************************************************

    // We only consider 1 key in this spec but it is easy to
    // extend to multiple keys if needed
    pure val DefaultKey = "default"
    pure val DefaultExpireDuration = 3
    pure val ClientProcesses: Set[ClientPID] = 1.to(10)
    pure val MaxVal = 1000000
    pure val Expired = -99
    pure val NotFound = -98

    //**********************************************************
    // STATE MACHINE
    // State-dependent definitions and actions
    //**********************************************************

    var l1: CacheLayer
    var l2: CacheLayer
    var num: int

    // Global log of system events. Use to specify correctness
    // properties below.
    var history: List[HistoryEntry]

    //**********************************************************
    // FUNCTIONAL LAYER
    // Values and functions that are state-independent
    //**********************************************************

    pure def isWrite(entry: HistoryEntry): bool = {
        match entry {
            | Write(_) => true
            | _ => false
        }
    }

    pure def isRead(entry: HistoryEntry): bool = {
        match entry {
            | Read(_) => true
            | _ => false
        }
    }

    pure def value(entry: HistoryEntry): int = {
        match entry {
            | Read(v) => v
            | Write(v) => v
        }
    }

    pure def isNotEmpty(l: CacheLayer): bool = {
        l.keys().size() > 0
    }

    //**********************************************************
    // HELPERS
    // Operators for convenience
    //**********************************************************

    action writeL1(v: int): bool = all {
        l1' = l1.put(DefaultKey, v)
    }

    action writeL2(v: int): bool = all {
        l2' = l2.put(DefaultKey, v)
    }

    //**********************************************************
    // ACTIONS
    //**********************************************************

    action writeCache(pid: ClientPID, v: int): bool = all {
        writeL1(v),
        writeL2(v),
        history' = history.append(Write(v))
    }

    action handleNotFound(): bool = all {
        l1' = l1,
        l2' = l2,
        history' = history.append(Read(NotFound))
    }

    action handleL1Found(): bool = {
        val value = l1.get(DefaultKey)
        all {
            l1' = l1,
            l2' = l2,
            history' = history.append(Read(value))
        }
    }

    action handleL2Found(): bool = {
        val value = l2.get(DefaultKey)
        all {
            writeL1(value),
            l2' = l2,
            history' = history.append(Read(value))
        }
    }

    action handleFound(): bool = {
        if (isNotEmpty(l1)) {
            handleL1Found
        } else {
            handleL2Found
        }
    }

    // If val doesn't exist in L1, read from L2.
    // If val exists in L2, write back to L1 then return.
    // Otherwise, not found (false).
    action readCache(pid: ClientPID): bool = {
        if (isNotEmpty(l1) or isNotEmpty(l2)) {
            handleFound
        } else {
            handleNotFound
        }
    }

    action clientProc = all {
        nondet pid = ClientProcesses.oneOf()
        
        any {
            all {
                num' = num + 1,
                writeCache(pid, num)
            },
            all {
                num' = num,
                readCache(pid),
            }
        },
    }

    // Clear layer 1 data to simulate its
    // volatility. Because in practice, layer 1
    // usually uses memory for storage.
    action l1Expire = all {
        any {
            l1' = l1,
            l1' = Map()
        },
        l2' = l2,
        num' = num,
        history' = history
    }

    action stutter = all {
        num' = num,
        l1' = l1,
        l2' = l2,
        history' = history,
    }

    action init = all {
        num' = 0,
        l1' = Map(),
        l2' = Map(),
        history' = [],
    }

    action step = all {
      // Limit the state space to enable exploration with TLC
      history.length() < 15,
      any {
          clientProc,
          stutter,
          l1Expire
      }
    }

    //**********************************************************
    // CORRECTNESS
    // 1. Safety Properties / Invariants
    //**********************************************************

    // Read the latest write
    val readAfterWrite: bool = {
        val idx = history.indices()
        idx.forall(i => {
            idx.forall(j => {
                i < j
                and history[i].isWrite()
                and history[j].isRead()
                implies history[i].value() <= history[j].value()
            })
        })
    }

    // Later write must contain a greater value
    val writeAfterWrite: bool = {
        val idx = history.indices()
        idx.forall(i => {
            idx.forall(j => {
                i < j
                and history[i].isWrite()
                and history[j].isWrite()
                implies history[i].value() < history[j].value()
            })
        })
    }

    //**********************************************************
    // CORRECTNESS
    // 2. Liveness Properties / Temporal
    //**********************************************************

    // All layers contain the same latest written value
    temporal agreement: bool = eventually({
        val a = l1.get(DefaultKey)
        val b = l2.get(DefaultKey)
        a == b
    })

    //**********************************************************
    // QUICK TESTS
    //**********************************************************
    // run initAndStepTest = init.then(step)
}
</code></pre>
</div>



			</heading-anchors>
		</main>

		<footer class="footer sm:footer-horizontal bg-accent text-accent-content p-10">
			<nav>
				<h6 class="footer-title" id="open-source">Open Source</h6>
				<a href="https://github.com/prestonph/specstack" class="link link-hover">GitHub</a>
			</nav>
			<nav>
				<h6 class="footer-title" id="author">Author</h6>
				<a href="mailto:preston.p@fastmail.com" class="link link-hover">preston.p@fastmail.com</a>
				<a href="/blog" class="link link-hover">My Blog</a>
			</nav>
			<nav>
				<a href="https://www.11ty.dev/" class="link link-hover">Made with Eleventy v3.0.0</a>
			</nav>
		</footer>

		<!-- This page `/specs/quint/two_layered_cache/` was built on 2025-04-06T11:18:40.142Z -->
		<script type="module" src="/dist/vAf_QIlOuw.js"></script>
	</body>
</html>
